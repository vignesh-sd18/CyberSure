{% extends 'base.html' %}
{% block title %}Analytics Dashboard - CyberSure{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<style>
    :root{
        --primary:#1e40af;--primary-light:#3b82f6;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;
        --text-primary:#1f2937;--text-secondary:#6b7280;--surface:#f9fafb;
    }

    .chart-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 2rem;
        background: var(--surface);
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0,0,0,.08);
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem 0;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: white;
        border-radius: 12px;
    }

    .page-header h2 { font-weight: 700; font-size: 2rem; }
    .page-header p { color: rgba(255,255,255,.9); }

    .chart-card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        margin-top: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,.05);
    }

    .chart-card h3 {
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    canvas { max-height: 400px; }
</style>

<div class="chart-container">
    <div class="page-header">
        <h2>Analytics Dashboard</h2>
        <p>Visual insights into risk distribution, premiums, and coverage</p>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="chart-card">
                <h3>Risk Level Distribution</h3>
                <canvas id="riskChart"></canvas>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-card">
                <h3>Avg. Premium by Occupation</h3>
                <canvas id="premiumChart"></canvas>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-card">
                <h3>Total Coverage by Location</h3>
                <canvas id="coverageChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const ctx1 = document.getElementById('riskChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: {{ risk_counts.keys() | list | tojson }},
            datasets: [{
                data: {{ risk_counts.values() | list | tojson }},
                backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    const ctx2 = document.getElementById('premiumChart').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: {{ avg_premiums.keys() | list | tojson }},
            datasets: [{
                label: 'Avg Premium',
                data: {{ avg_premiums.values() | list | tojson }},
                backgroundColor: '#3b82f6',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    const ctx3 = document.getElementById('coverageChart').getContext('2d');
    new Chart(ctx3, {
        type: 'bar',
        data: {
            labels: {{ geo_coverage.keys() | list | tojson }},
            datasets: [{
                label: 'Total Coverage',
                data: {{ geo_coverage.values() | list | tojson }},
                backgroundColor: '#10b981',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
</script>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
{% endblock %}
{% endblock %}